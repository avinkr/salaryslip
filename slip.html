<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Payslip Generator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { background: #f5f7fa; }
    .main-container { max-width: 1100px; margin: auto; margin-top: 30px; background: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 3px 12px rgba(0,0,0,0.1);}
    #preview-container { border: 2px dashed #007bff; background: #f8fbff; border-radius: 8px; padding: 15px; margin-bottom: 18px;}
    .table thead { background: #007bff; color: white; }
    #import-actions { display: none; margin-top: 15px; }
  </style>
</head>
<body>
<div class="main-container">
  <h2 class="text-center mb-4">ðŸ“‘ Payslip Generator</h2>

  <!-- File Upload -->
  <div class="mb-3">
    <label for="file-input" class="form-label">Import Employee Data (CSV/Excel)</label>
    <input type="file" id="file-input" class="form-control" accept=".csv,.xlsx">
  </div>

  <!-- Import Actions -->
  <div id="import-actions" class="d-flex gap-2">
    <button id="generate-all-pdf" class="btn btn-success">Generate PDFs for Imported Records</button>
    <button id="clear-import" class="btn btn-outline-secondary">Clear Import</button>
  </div>

  <!-- Filter/Search -->
  <div class="row mb-3 mt-4">
    <div class="col-md-4"><input id="search-id" class="form-control" placeholder="Search by Employee ID"></div>
    <div class="col-md-4"><input id="search-dept" class="form-control" placeholder="Search by Department"></div>
    <div class="col-md-4"><input id="search-month" class="form-control" type="month"></div>
  </div>

  <!-- Form -->
  <form id="payslip-form" autocomplete="off" class="row g-3">
    <h5>Employee Details</h5>
    <div class="col-md-3"><input class="form-control" name="name" placeholder="Name" required></div>
    <div class="col-md-2"><input class="form-control" name="id" placeholder="ID" required></div>
    <div class="col-md-3"><input class="form-control" name="department" placeholder="Department"></div>
    <div class="col-md-2"><input class="form-control" name="designation" placeholder="Designation"></div>
    <div class="col-md-2"><input class="form-control" type="month" name="month" required></div>

    <h5>Earnings</h5>
    <div class="col-md-2"><input class="form-control" type="number" name="basic" placeholder="Basic" required></div>
    <div class="col-md-2"><input class="form-control" type="number" name="da" placeholder="DA"></div>
    <div class="col-md-2"><input class="form-control" type="number" name="hra" placeholder="HRA"></div>
    <div class="col-md-2"><input class="form-control" type="number" name="bonus" placeholder="Bonus"></div>
    <div class="col-md-2"><input class="form-control" type="number" name="travel" placeholder="Travel Allowance"></div>
    <div class="col-md-2"><input class="form-control" type="number" name="medical" placeholder="Medical"></div>

    <h5>Deductions</h5>
    <div class="col-md-2"><input class="form-control" type="number" name="pf" placeholder="PF"></div>
    <div class="col-md-2"><input class="form-control" type="number" name="it" placeholder="Income Tax"></div>
    <div class="col-md-2"><input class="form-control" type="number" name="loan" placeholder="Loan"></div>

    <h5>Other Details</h5>
    <div class="col-md-3"><input class="form-control" name="bank" placeholder="Bank A/C No"></div>
    <div class="col-md-3"><input class="form-control" name="pan" placeholder="PAN"></div>
    <div class="col-md-3"><input class="form-control" name="uan" placeholder="UAN"></div>

    <div class="col-12">
      <button type="submit" class="btn btn-primary">Add/Update Payslip</button>
      <button type="reset" class="btn btn-danger">Reset</button>
    </div>
  </form>

  <div id="preview-container" class="mt-3"></div>

  <!-- Table -->
  <table class="table table-bordered mt-3" id="payslip-table">
    <thead>
      <tr>
        <th>Name</th><th>ID</th><th>Department</th><th>Designation</th>
        <th>Month</th><th>Net Pay</th><th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="mt-3 d-flex gap-2">
    <button id="bulk-pdf" class="btn btn-success">Bulk PDF Download</button>
    <button id="export-excel" class="btn btn-secondary">Export to Excel</button>
    <button id="clear-storage" class="btn btn-warning">Clear LocalStorage</button>
  </div>
</div>

<script>
let payslips = JSON.parse(localStorage.getItem("payslips") || "[]");
let editIndex = null;
let lastImportCount = 0;
const form = document.getElementById('payslip-form');
const tbody = document.querySelector('#payslip-table tbody');
const importActions = document.getElementById('import-actions');
const generateAllPdfBtn = document.getElementById('generate-all-pdf');
const clearImportBtn = document.getElementById('clear-import');

// Save to localStorage
function saveData() { localStorage.setItem("payslips", JSON.stringify(payslips)); }

// Form Submit
form.addEventListener('submit', e => {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(form).entries());
  for (let k in data) data[k] = isNaN(data[k]) ? data[k] : Number(data[k]) || 0;
  if(editIndex!==null){ payslips[editIndex]=data; editIndex=null; }
  else payslips.push(data);
  form.reset(); saveData(); renderTable();
});

// Render Table
function renderTable() {
  tbody.innerHTML = '';
  let filtered = payslips.filter(p => {
    let id = document.getElementById('search-id').value.toLowerCase();
    let dept = document.getElementById('search-dept').value.toLowerCase();
    let month = document.getElementById('search-month').value;
    return (!id || p.id.toLowerCase().includes(id)) &&
           (!dept || p.department.toLowerCase().includes(dept)) &&
           (!month || p.month===month);
  });
  filtered.forEach((p,i)=>{
    let gross = p.basic+p.da+p.hra+p.bonus+p.travel+p.medical;
    let ded = p.pf+p.it+p.loan;
    let net = gross-ded;
    let tr = `<tr>
      <td>${p.name}</td><td>${p.id}</td><td>${p.department}</td><td>${p.designation}</td>
      <td>${p.month}</td><td>â‚¹${net.toFixed(2)}</td>
      <td>
        <button class="btn btn-sm btn-info" onclick="editEntry(${i})">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="deleteEntry(${i})">Del</button>
        <button class="btn btn-sm btn-primary" onclick="downloadPDF(${i})">PDF</button>
      </td></tr>`;
    tbody.insertAdjacentHTML('beforeend',tr);
  });
  if(filtered.length) renderPreview(filtered[filtered.length-1]); else document.getElementById('preview-container').innerHTML='';
}
renderTable();

// Preview
function renderPreview(p) {
  let gross = p.basic+p.da+p.hra+p.bonus+p.travel+p.medical;
  let ded = p.pf+p.it+p.loan;
  let net = gross-ded;
  document.getElementById('preview-container').innerHTML = `
    <h5>Payslip Preview</h5>
    <p><b>${p.name}</b> (${p.id}) - ${p.designation}, ${p.department}</p>
    <p>Month: ${p.month} | PAN: ${p.pan} | UAN: ${p.uan} | Bank: ${p.bank}</p>
    <p>Gross: â‚¹${gross} | Deductions: â‚¹${ded} | <b>Net: â‚¹${net}</b></p>
  `;
}

// Edit/Delete
window.editEntry = idx => { Object.entries(payslips[idx]).forEach(([k,v])=> form[k].value=v); editIndex=idx; }
window.deleteEntry = idx => { payslips.splice(idx,1); saveData(); renderTable(); }

// ðŸ“Œ Professional PDF Generation
// ðŸ“Œ Professional PDF Generation with Logo
window.downloadPDF = idx => {
  const { jsPDF } = window.jspdf; 
  let doc = new jsPDF();
  let p = payslips[idx];
  let gross = p.basic+p.da+p.hra+p.bonus+p.travel+p.medical;
  let ded = p.pf+p.it+p.loan;
  let net = gross-ded;

  // âœ… Load Logo from assets folder
  let logo = new Image();
  logo.src = "assets/dlr_logo.png";
  logo.onload = function () {
    // Header with Logo & Branding
    doc.addImage(logo, "PNG", 14, 10, 25, 25); // left corner
    doc.setFontSize(16);
    doc.setTextColor(0,74,173);
    doc.text("DLR Facility Management", 45, 18);
    doc.setFontSize(11);
    doc.setTextColor(50);
    doc.text("14/2, Xavier Layout, 4th Cross, Bangalore - 47", 45, 25);
    doc.setDrawColor(0,74,173);
    doc.line(14, 38, 195, 38);

    doc.setFontSize(14);
    doc.setTextColor(0);
    doc.text("Payslip", 95, 48);

    doc.setFontSize(11);
    doc.text(`Name: ${p.name}`, 14, 60);
    doc.text(`ID: ${p.id}`, 110, 60);
    doc.text(`Designation: ${p.designation}`, 14, 68);
    doc.text(`Department: ${p.department}`, 110, 68);
    doc.text(`Month: ${p.month}`, 14, 76);
    doc.text(`PAN: ${p.pan}`, 110, 76);
    doc.text(`UAN: ${p.uan}`, 14, 84);
    doc.text(`Bank A/C: ${p.bank}`, 110, 84);

    doc.autoTable({
      startY: 95,
      head:[[
        {content:"Earnings", styles:{fillColor:[0,74,173], textColor:[255,255,255]}}, 
        {content:"Amount", styles:{fillColor:[0,74,173], textColor:[255,255,255]}}, 
        {content:"Deductions", styles:{fillColor:[0,74,173], textColor:[255,255,255]}}, 
        {content:"Amount", styles:{fillColor:[0,74,173], textColor:[255,255,255]}}
      ]],
      body:[
        ["Basic", p.basic, "PF", p.pf],
        ["DA", p.da, "Income Tax", p.it],
        ["HRA", p.hra, "Loan", p.loan],
        ["Bonus", p.bonus, "", ""],
        ["Travel", p.travel, "", ""],
        ["Medical", p.medical, "", ""],
        ["Gross Salary", gross, "Total Deductions", ded],
        ["", "", "Net Pay", net]
      ],
      theme:'grid',
      styles:{fontSize:10, cellPadding:3},
      headStyles:{halign:'center'},
      columnStyles:{1:{halign:'right'}, 3:{halign:'right'}}
    });

    doc.setFontSize(9);
    doc.setTextColor(100);
    doc.text("This is a system-generated payslip and does not require a signature.", 14, doc.lastAutoTable.finalY + 15);

    doc.save(`${p.name}_${p.month}_Payslip.pdf`);
  };
};



// Bulk PDF
document.getElementById('bulk-pdf').addEventListener('click',()=> payslips.forEach((_,i)=>downloadPDF(i)));

// Export Excel
document.getElementById('export-excel').addEventListener('click',()=>{
  let ws=XLSX.utils.json_to_sheet(payslips);
  let wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Payslips");
  XLSX.writeFile(wb,"Payslips.xlsx");
});

// Clear storage
document.getElementById('clear-storage').addEventListener('click',()=>{ 
  localStorage.removeItem("payslips"); 
  payslips=[]; 
  renderTable(); 
  hideImportActions();
});

// CSV/Excel Import
document.getElementById("file-input").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = evt => {
    let data = new Uint8Array(evt.target.result);
    let workbook = XLSX.read(data, { type: "array" });
    let sheet = workbook.Sheets[workbook.SheetNames[0]];
    let jsonData = XLSX.utils.sheet_to_json(sheet);

    lastImportCount = jsonData.length;
    jsonData.forEach(row => {
      let entry = {
        name: row["Name"] || row["Employee Name"] || "",
        id: row["ID"] || row["Employee ID"] || "",
        department: row["Department"] || "",
        designation: row["Designation"] || "",
        month: row["Month"] || "",
        basic: Number(row["Basic"] || 0),
        da: Number(row["DA"] || 0),
        hra: Number(row["HRA"] || 0),
        bonus: Number(row["Bonus"] || 0),
        travel: Number(row["Travel"] || 0),
        medical: Number(row["Medical"] || 0),
        pf: Number(row["PF"] || 0),
        it: Number(row["Income Tax"] || 0),
        loan: Number(row["Loan"] || 0),
        bank: row["Bank A/C No"] || "",
        pan: row["PAN"] || "",
        uan: row["UAN"] || ""
      };
      payslips.push(entry);
    });

    saveData();
    renderTable();
    showImportActions();
    alert(`âœ… ${lastImportCount} employee records imported successfully!`);
  };
  reader.readAsArrayBuffer(file);
});

// Show import actions
function showImportActions() {
  importActions.style.display = 'flex';
  generateAllPdfBtn.textContent = `Generate PDFs for ${lastImportCount} Imported Records`;
}

// Hide import actions
function hideImportActions() {
  importActions.style.display = 'none';
  lastImportCount = 0;
}

// âœ… Generate PDFs for Imported Records
generateAllPdfBtn.addEventListener('click', () => {
  if (lastImportCount > 0) {
    const startIndex = payslips.length - lastImportCount;
    for (let i = startIndex; i < payslips.length; i++) {
      downloadPDF(i);
    }
    alert(`ðŸ“‚ ${lastImportCount} PDFs generated successfully!`);
    hideImportActions(); // optional, so button hides after generation
  }
});

// Clear import
clearImportBtn.addEventListener('click', hideImportActions);
</script>
</body>
</html>
