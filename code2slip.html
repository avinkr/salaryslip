<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Payslip Generator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { background: #f5f7fa; }
    .main-container { max-width: 1200px; margin: auto; margin-top: 30px; background: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 3px 12px rgba(0,0,0,0.1);}
    #preview-container { border: 2px dashed #007bff; background: #f8fbff; border-radius: 8px; padding: 15px; margin-bottom: 18px;}
    .table thead { background: #007bff; color: white; }
    #import-actions { display: none; margin-top: 15px; }
  </style>
</head>
<body>
<div class="main-container">
  <h2 class="text-center mb-4">ðŸ“‘ Payslip Generator</h2>

  <!-- File Upload -->
  <div class="mb-3">
    <label for="file-input" class="form-label">Import Employee Data (CSV/Excel)</label>
    <input type="file" id="file-input" class="form-control" accept=".csv,.xlsx">
  </div>

  <!-- Import Actions -->
  <div id="import-actions" class="d-flex gap-2">
    <button id="generate-all-pdf" class="btn btn-success">Generate PDFs for Imported Records</button>
    <button id="clear-import" class="btn btn-outline-secondary">Clear Import</button>
  </div>

  <!-- Form -->
  <form id="payslip-form" autocomplete="off" class="row g-3 mt-4">
    <h5>Employee Details</h5>
    <div class="col-md-2"><input class="form-control" name="id" placeholder="Emp ID" required></div>
    <div class="col-md-3"><input class="form-control" name="name" placeholder="Employee Name" required></div>
    <div class="col-md-3"><input class="form-control" name="designation" placeholder="Designation"></div>
    <div class="col-md-2"><input class="form-control" type="month" name="month" required></div>
    <div class="col-md-2"><input class="form-control" name="project" placeholder="Project"></div>
    <div class="col-md-3"><input class="form-control" name="pfno" placeholder="PF No"></div>
    <div class="col-md-3"><input class="form-control" name="esino" placeholder="ESI No"></div>
    <div class="col-md-3"><input class="form-control" type="date" name="doj" placeholder="DOJ"></div>
    <div class="col-md-2"><input class="form-control" type="number" name="days" placeholder="No of Days"></div>
    <div class="col-md-2"><input class="form-control" type="number" name="lop" placeholder="LOP"></div>
    <div class="col-md-3"><input class="form-control" name="pan" placeholder="PAN"></div>
    <div class="col-md-3"><input class="form-control" name="uan" placeholder="UAN"></div>
    <div class="col-md-3"><input class="form-control" name="bank" placeholder="Bank"></div>
    <div class="col-md-3"><input class="form-control" name="acno" placeholder="A/C No"></div>

    <h5>Earnings</h5>
    <div class="col-md-2"><input class="form-control" type="number" name="basic" placeholder="Basic"></div>
    <div class="col-md-2"><input class="form-control" type="number" name="da" placeholder="DA"></div>
    <div class="col-md-2"><input class="form-control" type="number" name="hra" placeholder="HRA"></div>
    <div class="col-md-2"><input class="form-control" type="number" name="conveyance" placeholder="Conveyance"></div>
    <div class="col-md-2"><input class="form-control" type="number" name="other" placeholder="Other Allowances"></div>
    <div class="col-md-2"><input class="form-control" type="number" name="statbonus" placeholder="Stat Bonus"></div>
    <div class="col-md-2"><input class="form-control" type="number" name="performance" placeholder="Performance"></div>

    <h5>Deductions</h5>
    <div class="col-md-2"><input class="form-control" type="number" name="pf" placeholder="PF"></div>
    <div class="col-md-2"><input class="form-control" type="number" name="pt" placeholder="PT"></div>
    <div class="col-md-2"><input class="form-control" type="number" name="gmc" placeholder="GMC"></div>

    <div class="col-12">
      <button type="submit" class="btn btn-primary">Add/Update Payslip</button>
      <button type="reset" class="btn btn-danger">Reset</button>
    </div>
  </form>

  <!-- Table -->
  <table class="table table-bordered mt-3" id="payslip-table">
    <thead>
      <tr>
        <th>Name</th><th>ID</th><th>Designation</th><th>Month</th>
        <th>Net Pay</th><th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="mt-3 d-flex gap-2">
    <button id="bulk-pdf" class="btn btn-success">Bulk PDF Download</button>
    <button id="export-excel" class="btn btn-secondary">Export to Excel</button>
    <button id="clear-storage" class="btn btn-warning">Clear LocalStorage</button>
  </div>
</div>

<script>
let payslips = JSON.parse(localStorage.getItem("payslips") || "[]");
let editIndex = null;
let lastImportCount = 0;
const form = document.getElementById('payslip-form');
const tbody = document.querySelector('#payslip-table tbody');
const importActions = document.getElementById('import-actions');
const generateAllPdfBtn = document.getElementById('generate-all-pdf');
const clearImportBtn = document.getElementById('clear-import');

function saveData(){ localStorage.setItem("payslips", JSON.stringify(payslips)); }

form.addEventListener('submit', e=>{
  e.preventDefault();
  let data = Object.fromEntries(new FormData(form).entries());
  for (let k in data) data[k] = isNaN(data[k]) || data[k]==="" ? data[k] : Number(data[k]);
  if(editIndex!==null){ payslips[editIndex]=data; editIndex=null; }
  else payslips.push(data);
  form.reset(); saveData(); renderTable();
});

function renderTable(){
  tbody.innerHTML='';
  payslips.forEach((p,i)=>{
    let gross = (p.basic||0)+(p.da||0)+(p.hra||0)+(p.conveyance||0)+(p.other||0)+(p.statbonus||0)+(p.performance||0);
    let ded = (p.pf||0)+(p.pt||0)+(p.gmc||0);
    let net = gross-ded;
    tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${p.name}</td><td>${p.id}</td><td>${p.designation}</td><td>${p.month}</td>
        <td>â‚¹${net.toFixed(2)}</td>
        <td>
          <button class="btn btn-sm btn-info" onclick="editEntry(${i})">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="deleteEntry(${i})">Del</button>
          <button class="btn btn-sm btn-primary" onclick="downloadPDF(${i})">PDF</button>
        </td>
      </tr>
    `);
  });
}
renderTable();

window.editEntry = i=>{ Object.entries(payslips[i]).forEach(([k,v])=> form[k].value=v); editIndex=i; }
window.deleteEntry = i=>{ payslips.splice(i,1); saveData(); renderTable(); }

function numberToWords(num) {
  const a=["","One","Two","Three","Four","Five","Six","Seven","Eight","Nine","Ten","Eleven","Twelve","Thirteen","Fourteen","Fifteen","Sixteen","Seventeen","Eighteen","Nineteen"];
  const b=["","","Twenty","Thirty","Forty","Fifty","Sixty","Seventy","Eighty","Ninety"];
  if(num===0) return "Zero";
  function inWords(n){
    if(n<20) return a[n];
    if(n<100) return b[Math.floor(n/10)]+" "+a[n%10];
    if(n<1000) return a[Math.floor(n/100)]+" Hundred "+inWords(n%100);
    if(n<100000) return inWords(Math.floor(n/1000))+" Thousand "+inWords(n%1000);
    return n;
  }
  return inWords(num).trim();
}

window.downloadPDF = idx => {
  const { jsPDF } = window.jspdf;
  let doc = new jsPDF({ unit: "pt", format: "a4" });
  let p = payslips[idx];

  let gross = (p.basic||0)+(p.da||0)+(p.hra||0)+(p.conveyance||0)+(p.other||0)+(p.statbonus||0)+(p.performance||0);
  let ded   = (p.pf||0)+(p.pt||0)+(p.gmc||0);
  let net   = gross - ded;

  let logo = new Image();
  logo.src = "assets/dlr_logo.png";

  logo.onload = function () {
    // Outer Border
    doc.setLineWidth(1);
    doc.rect(30, 20, 540, 750);  // full payslip box

    // Logo
    doc.addImage(logo, "PNG", 40, 25, 120, 60);

    // Company Name + Address
    doc.setFontSize(14);
    doc.setFont("helvetica", "bold");
    doc.text("DLR Facility Management", 170, 45);

    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");

    let address = "No.101, 1st floor, KPR Residency, SV Balraj Reddy Colony, Behind Central Board, Bangalore - 560068";

// Auto wrap text within 100 units width
    let wrappedAddress = doc.splitTextToSize(address, 100);

// Print wrapped text (each line automatically placed under the previous one)
   doc.text(wrappedAddress, 20, 65);  // x=20 (left margin), y=65 (top position)


    // Salary Slip Title
    doc.setFontSize(12);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(255,255,255);
    doc.setFillColor(100,100,100);
    doc.rect(30, 100, 540, 20, "F");
    doc.text(`Salary Slip for the month of ${p.month}`, 300, 115, { align: "center" });

    doc.setTextColor(0,0,0);

    // Employee Details Table
    doc.autoTable({
      startY: 130,
      head: [],
      body: [
        [{content:`Emp ID: ${p.id}`, styles:{halign:"left"}}, {content:`Emp Name: ${p.name}`}],
        [{content:`Project: ${p.project}`}, {content:`Designation: ${p.designation}`}],
        [{content:`PF No: ${p.pfno}`}, {content:`ESI No: ${p.esino}`}],
        [{content:`No of Days: ${p.days}`}, {content:`LOP: ${p.lop}`}],
        [{content:`DOJ: ${p.doj}`}, {content:`UAN: ${p.uan}`}],
        [{content:`PAN: ${p.pan}`}, {content:`AC No: ${p.acno}`}],
        [{content:`Mode of Pay: ${p.bank}`, colSpan: 2}]
      ],
      theme: "grid",
      styles: { fontSize: 9, cellPadding: 3 },
      tableWidth: 540,
      margin: { left: 30 }
    });

    // Earnings & Deductions
    doc.autoTable({
      startY: doc.lastAutoTable.finalY + 10,
      head: [["Earnings", "Amount", "Deductions", "Amount"]],
      body: [
        ["BASIC", p.basic, "PF", p.pf],
        ["DA", p.da, "PT", p.pt],
        ["HRA", p.hra, "GMC", p.gmc],
        ["CONVEYANCE", p.conveyance, "", ""],
        ["OTHER ALLW", p.other, "", ""],
        ["STAT BONUS", p.statbonus, "", ""],
        ["PERFORMANCE", p.performance, "", ""],
        ["Total", gross, "Total", ded]
      ],
      theme: "grid",
      styles: { fontSize: 9, cellPadding: 3 },
      headStyles: { fillColor: [100,100,100], textColor: [255,255,255] },
      tableWidth: 540,
      margin: { left: 30 }
    });

    let y = doc.lastAutoTable.finalY + 15;
    doc.setFontSize(10);
    doc.text(`Net Pay: ${net.toFixed(2)}`, 40, y);
    doc.text(`In Words: Rupees ${numberToWords(net)} Only`, 40, y + 15);
    doc.text("Signature", 500, y + 40);

    doc.setFontSize(9);
    doc.text("This is Computer Generated Pay Slip, hence Signature is not required.", 40, y + 70);

    doc.save(`${p.name}_${p.month}_Payslip.pdf`);
  };
};


// Bulk PDF
document.getElementById('bulk-pdf').addEventListener('click',()=> payslips.forEach((_,i)=>downloadPDF(i)));

// Export Excel
document.getElementById('export-excel').addEventListener('click',()=>{
  let ws=XLSX.utils.json_to_sheet(payslips);
  let wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Payslips");
  XLSX.writeFile(wb,"Payslips.xlsx");
});

// Clear storage
document.getElementById('clear-storage').addEventListener('click',()=>{
  localStorage.removeItem("payslips"); payslips=[]; renderTable(); hideImportActions();
});

// Import
document.getElementById("file-input").addEventListener("change", e=>{
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=evt=>{
    let data=new Uint8Array(evt.target.result);
    let workbook=XLSX.read(data,{type:"array"});
    let sheet=workbook.Sheets[workbook.SheetNames[0]];
    let jsonData=XLSX.utils.sheet_to_json(sheet);
    lastImportCount=jsonData.length;
    jsonData.forEach(row=>{
      payslips.push({
        id:row["Emp ID"]||"",
        name:row["Emp Name"]||"",
        designation:row["Designation"]||"",
        month:row["Month"]||"",
        project:row["Project"]||"",
        pfno:row["PF No"]||"",
        esino:row["ESI No"]||"",
        days:Number(row["No of Days"]||0),
        lop:Number(row["LOP"]||0),
        doj:row["DOJ"]||"",
        uan:row["UAN"]||"",
        pan:row["PAN"]||"",
        bank:row["Bank"]||"",
        acno:row["AC No"]||"",
        basic:Number(row["Basic"]||0),
        da:Number(row["DA"]||0),
        hra:Number(row["HRA"]||0),
        conveyance:Number(row["Conveyance"]||0),
        other:Number(row["Other Allowances"]||0),
        statbonus:Number(row["Stat Bonus"]||0),
        performance:Number(row["Performance"]||0),
        pf:Number(row["PF"]||0),
        pt:Number(row["PT"]||0),
        gmc:Number(row["GMC"]||0)
      });
    });
    saveData(); renderTable(); showImportActions();
    alert(`âœ… ${lastImportCount} employee records imported successfully!`);
  };
  reader.readAsArrayBuffer(file);
});

function showImportActions(){ importActions.style.display='flex'; generateAllPdfBtn.textContent=`Generate PDFs for ${lastImportCount} Imported Records`; }
function hideImportActions(){ importActions.style.display='none'; lastImportCount=0; }

generateAllPdfBtn.addEventListener('click',()=>{
  if(lastImportCount>0){
    const start=payslips.length-lastImportCount;
    for(let i=start;i<payslips.length;i++){ downloadPDF(i); }
    alert(`ðŸ“‚ ${lastImportCount} PDFs generated successfully!`);
    hideImportActions();
  }
});
clearImportBtn.addEventListener('click',hideImportActions);
</script>
</body>
</html>



